(window.webpackJsonp=window.webpackJsonp||[]).push([[181],{257:function(e,t,a){"use strict";a.r(t);var n=a(2),s=Object(n.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"小程序导出数据到excel表，借助云开发后台实现excel数据的保存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小程序导出数据到excel表，借助云开发后台实现excel数据的保存","aria-hidden":"true"}},[e._v("#")]),e._v(" 小程序导出数据到excel表，借助云开发后台实现excel数据的保存")]),e._v(" "),a("blockquote",[a("p",[e._v("我们在开发小程序的过程中，可能会有这样的需求：如何将云数据库里的数据批量导出到excel表里？\n这个需求可以用强大的云开发轻松实现！\n这里需要用到云函数，云存储和云数据库。可以说通过这一个例子，把小程序云开发相关的知识都用到了。下面就来介绍如何实现")])]),e._v(" "),a("h1",{attrs:{id:"实现思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现思路","aria-hidden":"true"}},[e._v("#")]),e._v(" 实现思路")]),e._v(" "),a("ul",[a("li",[e._v("1，创建云函数")]),e._v(" "),a("li",[e._v("2，在云函数里读取云数据库里的数据")]),e._v(" "),a("li",[e._v("3，安装node-xlsx类库（node类库）")]),e._v(" "),a("li",[e._v("4，把云数据库里读取到的数据存到excel里")]),e._v(" "),a("li",[e._v("5，把excel存到云存储里并返回对应的云文件地址")]),e._v(" "),a("li",[e._v("6，通过云文件地址下载excel文件")])]),e._v(" "),a("h1",{attrs:{id:"一、创建excel云函数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、创建excel云函数","aria-hidden":"true"}},[e._v("#")]),e._v(" 一、创建excel云函数")]),e._v(" "),a("p",[e._v("关于如何创建云开发小程序，这里我就不再做具体讲解。不知道怎么创建云开发小程序的同学，可以去翻看腾讯云云开发公众号内菜单【技术交流-视频教程】中的教学视频。")]),e._v(" "),a("h4",{attrs:{id:"创建云函数时有两点需要注意的，给大家说下"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建云函数时有两点需要注意的，给大家说下","aria-hidden":"true"}},[e._v("#")]),e._v(" 创建云函数时有两点需要注意的，给大家说下")]),e._v(" "),a("ul",[a("li",[e._v("1、一定要把app.js里的环境id换成你自己的\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGFlYzQ0Njg2NjJlZQ?x-oss-process=image/format,png#pic_center",alt:""}})]),e._v(" "),a("li",[e._v("2，你的云函数目录要选择你对应的云开发环境（通常这里默认选中的）\n不过你这里的云开发环境要和你app.js里的保持一致\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGFlY2U2OWY1NjY4OA?x-oss-process=image/format,png#pic_center",alt:""}})])]),e._v(" "),a("h1",{attrs:{id:"二、读取云数据库里的数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、读取云数据库里的数据","aria-hidden":"true"}},[e._v("#")]),e._v(" 二、读取云数据库里的数据")]),e._v(" "),a("p",[e._v("我们第一步创建好云函数以后，可以先在云函数里读取我们的云数据库里的数据。")]),e._v(" "),a("ul",[a("li",[e._v("1、先看下我们云数据库里的数据\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGFmMTY0ZjQxNWRkZg?x-oss-process=image/format,png#pic_center",alt:""}})]),e._v(" "),a("li",[e._v("2、编写云函数，读取云数据库里的数据（一定要记得部署云函数）\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGIyN2EzYzU2ZmFiNA?x-oss-process=image/format,png#pic_center",alt:""}})]),e._v(" "),a("li",[e._v("3、成功读取到数据\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGFmYjg3MTIxM2VlYw?x-oss-process=image/format,png#pic_center",alt:""}})])]),e._v(" "),a("p",[e._v("把读取user数据表的完整代码给大家贴出来。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("// 云函数入口文件\nconst cloud = require('wx-server-sdk')\ncloud.init({\n  env: \"test-vsbkm\"\n})\n// 云函数入口函数\nexports.main = async(event, context) => {\n  return await cloud.database().collection('users').get();\n}\n")])])]),a("h1",{attrs:{id:"三、安装生成excel文件的类库-node-xlsx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、安装生成excel文件的类库-node-xlsx","aria-hidden":"true"}},[e._v("#")]),e._v(" 三、安装生成excel文件的类库 node-xlsx")]),e._v(" "),a("p",[e._v("通过上面第二步可以看到我们已经成功的拿到需要保存到excel的源数据，我们接下来要做的就是把数据保存到excel")]),e._v(" "),a("ul",[a("li",[e._v("1、安装node-xlsx类库\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGFmZWZhYTBhNDA2YQ?x-oss-process=image/format,png#pic_center",alt:""}}),e._v("\n这一步需要我们事先安装node,因为我们要用到npm命令，通过命令行")])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("npm install node-xlsx\n")])])]),a("p",[a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGIwMDgyMjE0YWE1OQ?x-oss-process=image/format,png#pic_center",alt:""}})]),e._v(" "),a("p",[e._v("可以看出我们安装完成以后，多了一个package-lock.json的文件\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGIwMTI0MWQ2YmU4ZQ?x-oss-process=image/format,png#pic_center",alt:""}})]),e._v(" "),a("h1",{attrs:{id:"四、编写把数据保存到excel的代码，"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、编写把数据保存到excel的代码，","aria-hidden":"true"}},[e._v("#")]),e._v(" 四、编写把数据保存到excel的代码，")]),e._v(" "),a("p",[e._v("下图是我们的核心代码：\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGIyNmNhOTJiN2YwNQ?x-oss-process=image/format,png#pic_center",alt:""}}),e._v("\n这里的数据是我们查询的users表的数据，然后通过下面代码遍历数组，然后存入excel。这里需要注意我们的id,name,weixin要和users表里的对应。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("   for (let key in userdata) {\n      let arr = [];\n      arr.push(userdata[key].id);\n      arr.push(userdata[key].name);\n      arr.push(userdata[key].weixin);\n      alldata.push(arr)\n    }\n")])])]),a("p",[e._v("还有下面这段代码，是把excel保存到云存储用的")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    //4，把excel文件保存到云存储里\n    return await cloud.uploadFile({\n      cloudPath: dataCVS,\n      fileContent: buffer, //excel二进制文件\n    })\n")])])]),a("p",[e._v("下面把完整的excel里的index.js代码贴给大家,记得把云开发环境id换成你自己的。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("const cloud = require('wx-server-sdk')\n//这里最好也初始化一下你的云开发环境\ncloud.init({\n  env: \"test-vsbkm\"\n})\n//操作excel用的类库\nconst xlsx = require('node-xlsx');\n\n// 云函数入口函数\nexports.main = async(event, context) => {\n  try {\n    let {userdata} = event\n    \n    //1,定义excel表格名\n    let dataCVS = 'test.xlsx'\n    //2，定义存储数据的\n    let alldata = [];\n    let row = ['id', '姓名', '微信号']; //表属性\n    alldata.push(row);\n\n    for (let key in userdata) {\n      let arr = [];\n      arr.push(userdata[key].id);\n      arr.push(userdata[key].name);\n      arr.push(userdata[key].weixin);\n      alldata.push(arr)\n    }\n    //3，把数据保存到excel里\n    var buffer = await xlsx.build([{\n      name: \"mySheetName\",\n      data: alldata\n    }]);\n    //4，把excel文件保存到云存储里\n    return await cloud.uploadFile({\n      cloudPath: dataCVS,\n      fileContent: buffer, //excel二进制文件\n    })\n\n  } catch (e) {\n    console.error(e)\n    return e\n  }\n}\n\n")])])]),a("h1",{attrs:{id:"五、把excel存到云存储里并返回对应的云文件地址"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、把excel存到云存储里并返回对应的云文件地址","aria-hidden":"true"}},[e._v("#")]),e._v(" 五、把excel存到云存储里并返回对应的云文件地址")]),e._v(" "),a("p",[e._v("经过上面的步骤，我们已经成功的把数据存到excel里，并把excel文件存到云存储里。可以看下效果。\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGIyZTA0MWQ0YzdjYg?x-oss-process=image/format,png#pic_center",alt:""}}),e._v("\n接着，就可以通过上图的下载地址下载excel文件了。\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGIyZjNlOWFkODU1Nw?x-oss-process=image/format,png#pic_center",alt:""}}),e._v("\n其实到这里就差不多实现了基本的把数据保存到excel里的功能了，但是为了避免每次导出数据都需要去云开发后台下载excel的麻烦，接下来介绍如何动态获取下载地址。")]),e._v(" "),a("h1",{attrs:{id:"六、获取云文件地址下载excel文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、获取云文件地址下载excel文件","aria-hidden":"true"}},[e._v("#")]),e._v(" 六、获取云文件地址下载excel文件")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGIzNjEzMWE3ZTg5MQ?x-oss-process=image/format,png#pic_center",alt:""}}),e._v("\n通过上图我们可以看出，我们获取下载链接需要用到一个fileID,而这个fileID在我们保存excel到云存储时，有返回，如下图。我们把fileID传给我们获取下载链接的方法即可。\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGIzNzZmZTBmZTZkNw?x-oss-process=image/format,png#pic_center",alt:""}})]),e._v(" "),a("ul",[a("li",[e._v("1、我们获取到了下载链接，接下来就要把下载链接显示到页面\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGIzYWRhYjIyM2U4Nw?x-oss-process=image/format,png#pic_center",alt:""}})]),e._v(" "),a("li",[e._v("2、代码显示到页面以后，我们就要复制这个链接，方便用户粘贴到浏览器或者微信去下载。\n"),a("img",{attrs:{src:"https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOS85LzcvMTZkMGI0MDhjMTIzMTJjNA?x-oss-process=image/format,png#pic_center",alt:""}})])]),e._v(" "),a("p",[e._v("下面是完整代码：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('Page({\n  onLoad: function(options) {\n    let that = this;\n    //读取users表数据\n    wx.cloud.callFunction({\n      name: "getUsers",\n      success(res) {\n        console.log("读取成功", res.result.data)\n        that.savaExcel(res.result.data)\n      },\n      fail(res) {\n        console.log("读取失败", res)\n      }\n    })\n  },\n\n  //把数据保存到excel里，并把excel保存到云存储\n  savaExcel(userdata) {\n    let that = this\n    wx.cloud.callFunction({\n      name: "excel",\n      data: {\n        userdata: userdata\n      },\n      success(res) {\n        console.log("保存成功", res)\n        that.getFileUrl(res.result.fileID)\n      },\n      fail(res) {\n        console.log("保存失败", res)\n      }\n    })\n  },\n\n  //获取云存储文件下载地址，这个地址有效期一天\n  getFileUrl(fileID) {\n    let that = this;\n    wx.cloud.getTempFileURL({\n      fileList: [fileID],\n      success: res => {\n        // get temp file URL\n        console.log("文件下载链接", res.fileList[0].tempFileURL)\n        that.setData({\n          fileUrl: res.fileList[0].tempFileURL\n        })\n      },\n      fail: err => {\n        // handle error\n      }\n    })\n  },\n  //复制excel文件下载链接\n  copyFileUrl() {\n    let that=this\n    wx.setClipboardData({\n      data: that.data.fileUrl,\n      success(res) {\n        wx.getClipboardData({\n          success(res) {\n            console.log("复制成功",res.data) // data\n          }\n        })\n      }\n    })\n  }\n})\n')])])]),a("p",[e._v("梳理下上面代码的逻辑：")]),e._v(" "),a("ul",[a("li",[e._v("1、先通过getUsers云函数去云数据库获取数据。")]),e._v(" "),a("li",[e._v("2、把获取到的数据通过excel云函数把数据保存到excel，然后把excel保存的云存储。")]),e._v(" "),a("li",[e._v("3、获取云存储里的文件下载链接。")]),e._v(" "),a("li",[e._v("4、复制下载链接，到浏览器里下载excel文件。")])]),e._v(" "),a("p",[e._v("到这里我们就完整的实现了把数据保存到excel的功能了。")]),e._v(" "),a("p",[e._v("文章有点长，知识点有点多，但是大家理解上述内容后，就可以对小程序云开发的云函数、云数据库、云存储有一个较为完整的了解过程。")]),e._v(" "),a("hr"),e._v(" "),a("p",[e._v("如果你想要了解更多关于云开发CloudBase相关的技术故事/技术实战经验，请扫码关注【腾讯云云开发】公众号～")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190910094810571.png#pic_center",alt:"在这里插入图片描述"}})])])}),[],!1,null,null,null);t.default=s.exports}}]);