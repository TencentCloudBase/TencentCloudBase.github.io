(window.webpackJsonp=window.webpackJsonp||[]).push([[209],{485:function(t,a,n){"use strict";n.r(a);var e=n(14),s=Object(e.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h2",{attrs:{id:"_1-小程序功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-小程序功能"}},[t._v("#")]),t._v(" 1. 小程序功能")]),t._v(" "),n("ul",[n("li",[t._v("古诗词大全")]),t._v(" "),n("li",[t._v("成语大全")]),t._v(" "),n("li",[t._v("成语接龙")]),t._v(" "),n("li",[t._v("诗词飞花令")]),t._v(" "),n("li",[t._v("诗词分享、收藏")]),t._v(" "),n("li",[t._v("诗词接龙")]),t._v(" "),n("li",[t._v("唐诗宋词起名字")]),t._v(" "),n("li",[t._v("百家姓")]),t._v(" "),n("li",[t._v("猜谜语")])]),t._v(" "),n("h2",{attrs:{id:"_2-小程序预览"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-小程序预览"}},[t._v("#")]),t._v(" 2. 小程序预览：")]),t._v(" "),n("br"),t._v(" "),n("img",{attrs:{src:"https://puui.qpic.cn/vupload/0/20190809_1565314668113_0ascs92ffzmi.jpeg/0",width:"240"}}),t._v(" "),n("br"),t._v(" "),n("h2",{attrs:{id:"_3-部分截图"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-部分截图"}},[t._v("#")]),t._v(" 3. 部分截图")]),t._v(" "),n("h4",{attrs:{id:"首页"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#首页"}},[t._v("#")]),t._v(" 首页")]),t._v(" "),n("img",{attrs:{src:"https://puui.qpic.cn/vupload/0/20190808_1565261440163_r41j6cqlqhg.png/0",width:"225",height:"400"}}),t._v(" "),n("h4",{attrs:{id:"列表页"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#列表页"}},[t._v("#")]),t._v(" 列表页")]),t._v(" "),n("img",{attrs:{src:"https://puui.qpic.cn/vupload/0/20190809_1565314716650_iqy2nphl2g.jpeg/0",width:"225",height:"400"}}),t._v(" "),n("h4",{attrs:{id:"详情页-分享页"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#详情页-分享页"}},[t._v("#")]),t._v(" 详情页 分享页")]),t._v(" "),n("img",{attrs:{src:"https://puui.qpic.cn/vupload/0/20190808_1565261462797_mrto0hl9w6k.png/0",width:"225",height:"400"}}),t._v(" "),n("h4",{attrs:{id:"唐诗宋词"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#唐诗宋词"}},[t._v("#")]),t._v(" 唐诗宋词")]),t._v(" "),n("img",{attrs:{src:"https://puui.qpic.cn/vupload/0/20190809_1565314768436_v7jcaf044iq.jpeg/0",width:"225",height:"400"}}),t._v(" "),n("h4",{attrs:{id:"成语接龙"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#成语接龙"}},[t._v("#")]),t._v(" 成语接龙")]),t._v(" "),n("img",{attrs:{src:"https://puui.qpic.cn/vupload/0/20190809_1565314789707_4vqdq806njw.jpeg/0",width:"225",height:"400"}}),t._v(" "),n("h2",{attrs:{id:"_4-项目结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-项目结构"}},[t._v("#")]),t._v(" 4. 项目结构")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v(".\n├── README.md\n├── project.config.json                              // 项目配置文件\n├── cloudfunctions | 云环境                           // 存放云函数的目录\n│   ├── login                                        // 用户登录云函数\n│   │   ├── index.js\n│   │   └── package.json\n│   └── collection_get                               // 数据库查询云函数\n│   │   ├── index.js\n│   │   └── package.json\n│   └── collection_update                               // 数据库更新云函数\n│       ├── index.js\n│       └── package.json\n└── miniprogram\n    ├── images                                        // 存放小程序图片\n    ├── lib                                           // 配置文件\n    ├── pages                                         // 小程序各种页面\n    |   ├── index                                     // 首页\n    |   └── menu                                      // 分类页\n    |   └── user                                      // 用户中心\n    |   └── search                                    // 搜索页\n    |   └── list                                      // 列表页 搜索结果页\n    |   └── detail                                    // 详情页\n    |   └── collection                                // 收藏页\n    |   └── find                                      // 发现页\n    |   └── idiom-jielong                             // 成语接龙页\n    |   └── poet                                      // 作者页\n    |   └── baijiaxing                                // 百家姓\n    |   └── xiehouyu                                  // 歇后语\n    |   └── poet                                      // 作者页\n    |   └── suggest                                   // 建议反馈\n    |   └── ...                                       // 其他\n    ├── style                                         // 样式文件目录\n    ├── app.js                                        // 小程序入口文件\n    ├── app.json                                      // 全局配置\n    └── app.wxss                                      // 全局样式\n\n")])])]),n("h2",{attrs:{id:"_5-封装云函数操作数据库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-封装云函数操作数据库"}},[t._v("#")]),t._v(" 5. 封装云函数操作数据库")]),t._v(" "),n("p",[t._v("本项目是使用的小程序云开发。云开发提供了一个 JSON 数据库，用户可以直接在云端进行数据库增删改查，但是，小程序对用户操作数据的权限进行了一定的限制（例如数据update、一次性get记录的条数限制等），所以，这里主要采用云函数来操作数据库。")]),t._v(" "),n("h3",{attrs:{id:"查询数据、分页查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#查询数据、分页查询"}},[t._v("#")]),t._v(" 查询数据、分页查询")]),t._v(" "),n("p",[t._v("函数根目录上右键，在右键菜单中，选择创建一个新的 Node.js 云函数，我们将该云函数命名为 collection_get。")]),t._v(" "),n("p",[t._v("编辑 index.js：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("// 云函数入口文件\nconst cloud = require('wx-server-sdk')\ncloud.init()\n\nconst db = cloud.database()\n\nexports.main = async (event, context) => {\n\n  /**\n   * page: 第几页\n   * num: 每页几条数据\n   * condition： 查询条件，例如 { name: '李白' }\n   */\n\n  const {database, page, num, condition} = event\n  console.log(event)\n\n  try {\n    return await db.collection(database)\n                  .where(condition)\n                  .skip(num * (page - 1))\n                  .limit(num)\n                  .get()\n  } catch (err) {\n    console.log(err)\n  }\n}\n\n")])])]),n("h4",{attrs:{id:"使用-collection-get-云函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用-collection-get-云函数"}},[t._v("#")]),t._v(" 使用 collection_get 云函数")]),t._v(" "),n("p",[t._v("例如，按照查询条件"),n("code",[t._v("{tags: '唐诗三百首'}")]),t._v("查询诗词列表，每页"),n("code",[t._v("num = 10")]),t._v("条数据:")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("let {list, page, num} = this.data\nlet that = this\n\nthis.setData({\n    loading: true\n})\n\nwx.cloud.callFunction({\n    name: 'collection_get',\n    data: {\n        database: 'gushici',\n        page,\n        num,\n        condition: {\n            tags: '唐诗三百首'\n        }\n    },\n    }).then(res => {\n        if(!res.result.data.length) { // 没搜索到\n            that.setData({\n                loading: false,\n                isOver: true\n            })\n        } else {\n            let res_data = res.result.data\n            list.push(...res_data)\n            that.setData({\n                list,\n                page: page + 1, // 页面加1\n                loading: false\n            })\n        }\n    })\n    .catch(console.error)\n}\n")])])]),n("h3",{attrs:{id:"更新数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#更新数据"}},[t._v("#")]),t._v(" 更新数据")]),t._v(" "),n("p",[t._v("注意，当我们向数据库中添加记录时，系统会自动帮我们为每条记录添加上用户的 "),n("code",[t._v("openid")]),t._v(" 字段，但如果，数据表是自己用 json/csv 文件导入的，就不存在 "),n("code",[t._v("openid")]),t._v(" 字段，此时，当更新这个数据表时，系统会认为你不是创建者，所以也就无法更新。")]),t._v(" "),n("p",[t._v("此时，就需要通过云函数更新数据库，新建云函数 collection_update, 编辑 index.js:")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("// 更新数据 - 根据 _id 更新已打开人数\nconst cloud = require('wx-server-sdk')\ncloud.init()\n\nconst db = cloud.database()\nconst _ = db.command\n\nexports.main = async (event, context) => {\n\n  const { id } = event\n  console.log(event)\n\n  try {\n    return await db.collection('gushici').doc(id)\n      .update({\n        data: {\n          opened: _.inc(1)\n        },\n      })\n  } catch (e) {\n    console.error(e)\n  }\n}\n")])])]),n("h4",{attrs:{id:"使用-collection-update-云函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用-collection-update-云函数"}},[t._v("#")]),t._v(" 使用 collection_update 云函数")]),t._v(" "),n("p",[t._v("更新某_id数据的打开人数：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("let _id = e.currentTarget.dataset.id\nwx.cloud.callFunction({\n    name: 'collection_update',\n    data: {\n        id: _id\n    },\n}).then(res => {\n    console.log(res.data)\n})\n.catch(console.error)\n")])])]),n("h2",{attrs:{id:"_6-数据库模糊查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-数据库模糊查询"}},[t._v("#")]),t._v(" 6. 数据库模糊查询")]),t._v(" "),n("p",[t._v("小程序云开发可以使用正则表达式进行模糊查询。例如， 根据用户输入关键词，查询标题中存在改关键词的古诗词。")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("let database = 'gushici'\nlet condition =  {\n    name: {\n        $regex:'.*'+ inputValue,\n        $options: 'i'\n    }\n}\n\nlet { list, page, num } = this.data\nlet that = this\n\nthis.setData({\n    loading: true\n})\n\n// 模糊查询\nwx.cloud.callFunction({\n    name: 'collection_get',\n    data: {\n        database,\n        page,\n        num,\n        condition\n    },\n}).then(res => {\n    if (!res.result.data.length) { // 没搜索到\n        that.setData({\n            loading: false,\n            isOver: true\n        })\n    } else {\n        let res_data = res.result.data\n        list.push(...res_data)\n        that.setData({\n            list,\n            loading: false\n        })\n    }\n})\n.catch(console.error)\n")])])]),n("h2",{attrs:{id:"_7-分享或转发功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-分享或转发功能"}},[t._v("#")]),t._v(" 7. 分享或转发功能")]),t._v(" "),n("p",[t._v("小程序中页面触发转发的方式有两种：")]),t._v(" "),n("ul",[n("li",[t._v("1.在小程序的右上角选择转发，需要定义函数 Page.onShareAppMessage，如果当前页面没有定义此事件，则点击后无效果。")]),t._v(" "),n("li",[t._v("2.通过给 "),n("code",[t._v("button")]),t._v(" 组件设置属性 "),n("code",[t._v('open-type="share"')]),t._v("，可以在用户点击按钮后触发 Page.onShareAppMessage 事件，如果当前页面没有定义此事件，则点击后无效果。")])]),t._v(" "),n("p",[t._v("用户还可以在 Page.onShareAppMessage 事件中自定义转发后显示的标题、图片、路径：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("onShareAppMessage(res) {\n    let id = wx.getStorageSync('shareId')\n    if (res.from === 'button') {\n        // 来自页面内转发按钮\n        console.log(res.target)\n    }\n    return {\n        title: `跟我一起挑战最长的成语接龙吧！`,\n        path: `pages/find/find`,\n        imageUrl: '/images/img.jpg',\n    }\n},\n")])])]),n("h4",{attrs:{id:"注意-转发成功-失败的-callback-已经被官方废弃-所以理论上小程序是无法得知用户是否将页面分享成功的"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#注意-转发成功-失败的-callback-已经被官方废弃-所以理论上小程序是无法得知用户是否将页面分享成功的"}},[t._v("#")]),t._v(" 注意：转发成功/失败的 callback 已经被官方废弃，所以理论上小程序是无法得知用户是否将页面分享成功的")]),t._v(" "),n("h2",{attrs:{id:"_8-用户授权"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-用户授权"}},[t._v("#")]),t._v(" 8. 用户授权")]),t._v(" "),n("p",[t._v("详情请参考文章："),n("a",{attrs:{href:"https://www.cnblogs.com/cckui/p/10000738.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信小程序之授权"),n("OutboundLink")],1)]),t._v(" "),n("h2",{attrs:{id:"_9-需要注意的几个坑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_9-需要注意的几个坑"}},[t._v("#")]),t._v(" 9. 需要注意的几个坑")]),t._v(" "),n("h3",{attrs:{id:"查询不到数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#查询不到数据"}},[t._v("#")]),t._v(" 查询不到数据")]),t._v(" "),n("p",[t._v("数据表中明明有数据，但是 collection.get 到的却为空。解决：可以在云开发控制台中打开数据库权限设置，设置权限。")]),t._v(" "),n("h3",{attrs:{id:"更新数据失败"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#更新数据失败"}},[t._v("#")]),t._v(" 更新数据失败")]),t._v(" "),n("p",[t._v("collection.update 函数调用成功单返回的却是0行记录被更新，因为小程序端不允许更新没有 openid 字段的数据。解决：可以通过云函数更新数据库。")]),t._v(" "),n("h3",{attrs:{id:"background-图片-url-不能为本地图片"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#background-图片-url-不能为本地图片"}},[t._v("#")]),t._v(" background 图片 url 不能为本地图片")]),t._v(" "),n("p",[t._v("解决：1：将图片上传到服务器，填写服务器上的图片路径地址。2：将图片转为 base64 编码。")]),t._v(" "),n("h3",{attrs:{id:"往云数据库中批量导入-json-数据失败"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#往云数据库中批量导入-json-数据失败"}},[t._v("#")]),t._v(" 往云数据库中批量导入 json 数据失败")]),t._v(" "),n("p",[t._v("原因：请看文档："),n("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/import.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/import.html"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("解决：去掉json数据 "),n("code",[t._v("{}")]),t._v("之间的逗号, 如果最外层为 "),n("code",[t._v("[]")]),t._v("，也必须去掉, 最终形如：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('{\n    "index": "作者_1",\n    "type": "作者",\n    "poet": "李白",\n    "abstract": "李白（701年－762年），字太白，号青莲居士，唐朝浪漫主义诗人，被后人誉为“诗仙”..."\n}\n{\n    "index": "作者_2",\n    "type": "作者",\n    "poet": "白居易",\n    "abstract": "白居易（772年－846年），字乐天，号香山居士..."\n}\n')])])]),n("h2",{attrs:{id:"源码链接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#源码链接"}},[t._v("#")]),t._v(" 源码链接")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://github.com/caochangkui/miniprogram-project",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/caochangkui/miniprogram-project"),n("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=s.exports}}]);